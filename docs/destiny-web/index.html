<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>命运之书 Pro - 平行人生治愈版</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap');
        body { background: #020617; color: #f1f5f9; font-family: 'Noto Serif SC', serif; scroll-behavior: smooth; }
        .glass-card { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        .bazi-tag { background: #1e293b; border-left: 3px solid #6366f1; }
        .warning-tag { background: rgba(239, 68, 68, 0.05); border-left: 3px solid #ef4444; }
        .animate-fadeIn { animation: fadeIn 0.8s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loading-dots:after { content: ' .'; animation: dots 1.5s steps(5, end) infinite;}
        @keyframes dots { 0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); } 40% { color: white; } 60% { text-shadow: .25em 0 0 white; } 80%, 100% { text-shadow: .25em 0 0 white, .5em 0 0 white; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        const ENCODED_KEY = "c2stYjQ2OWIwNDNhNjE2NGNjODkzM2ZiZDg2M2I0NTgzMTg=";
        const getApiKey = () => atob(ENCODED_KEY);

        const App = () => {
            const [birthDate, setBirthDate] = useState('');
            const [birthTime, setBirthTime] = useState('子时');
            const [regret, setRegret] = useState('');
            const [fateData, setFateData] = useState(null);
            const [aiStory, setAiStory] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const calculateFate = () => {
                if (!birthDate) return alert("请先填写出生日期");
                const date = new Date(birthDate);
                const birthYear = date.getFullYear();
                const gan = ['庚', '辛', '壬', '癸', '甲', '乙', '丙', '丁', '戊', '己'];
                const zhi = ['申', '酉', '戌', '亥', '子', '丑', '寅', '卯', '辰', '巳', '午', '未'];

                const startAge = (birthYear % 10) || 5;
                const dayun = [];
                const dayunThemes = ["学业与探索", "事业与立业", "财富与守成", "智慧与养生"];
                const dayunSuits = ["适合求学深造", "适合创业开拓", "适合资产配置", "适合授业修身"];
                for(let i=0; i<4; i++) {
                    const startYear = birthYear + startAge + (i * 10);
                    dayun.push({ period: `${startYear}-${startYear+9}`, age: `${startAge+(i*10)}岁`, theme: dayunThemes[i], suit: dayunSuits[i] });
                }

                const liunian = [];
                const currentYear = 2026;
                const taboos = ["忌盲目跳槽", "忌大额借贷", "忌透支健康", "忌契约纠纷", "忌出海远走", "忌动土装修", "忌感情用事", "忌孤注一掷"];
                for(let i=0; i<8; i++) {
                    const year = currentYear + i;
                    liunian.push({ year, name: gan[year % 10] + zhi[year % 12], taboo: taboos[(year + date.getDate()) % taboos.length] });
                }
                setFateData({ dayun, liunian });
            };

            const callDeepSeek = async () => {
                if (!regret) return alert("写下你的遗憾");
                setIsLoading(true);
                try {
                    const response = await fetch("https://api.deepseek.com/chat/completions", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${getApiKey()}` },
                        body: JSON.stringify({
                            model: "deepseek-chat",
                            messages: [{ role: "system", content: "你是一位精通命理的治愈系作家。请根据用户的遗憾，续写平行时空的故事，要求结局圆满、充满正能量，引导用户接纳过去并积极生活。" }, { role: "user", content: regret }],
                            temperature: 0.7
                        })
                    });
                    const data = await response.json();
                    setAiStory(data.choices[0].message.content);
                } catch (e) {
                    setAiStory("信号穿越中受阻，请稍后再试。");
                } finally { setIsLoading(false); }
            };

            return (
                <div className="min-h-screen p-4 flex flex-col items-center">
                    <header className="text-center my-8">
                        <h1 className="text-3xl font-bold bg-gradient-to-r from-indigo-400 to-purple-500 bg-clip-text text-transparent mb-2">命运之书 Pro</h1>
                        <p className="text-slate-500 text-sm italic italic">—— 探寻命理轨迹，缝补人生遗憾 ——</p>
                    </header>

                    <div className="w-full max-w-7xl space-y-6">
                        
                        {/* 上排：输入区 */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            {/* 左上：生辰输入 */}
                            <section className="glass-card p-8 rounded-3xl min-h-[280px] flex flex-col justify-center">
                                <h3 className="text-indigo-400 font-bold mb-6 flex items-center">
                                    <span className="w-6 h-6 rounded-full border border-indigo-400 flex items-center justify-center text-xs mr-2">1</span>
                                    设定生辰原点
                                </h3>
                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="space-y-1">
                                            <label className="text-[10px] text-slate-500 ml-1">出生日期</label>
                                            <input type="date" className="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl outline-none text-sm" onChange={e => setBirthDate(e.target.value)} />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="text-[10px] text-slate-500 ml-1">出生时辰</label>
                                            <select className="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl outline-none text-sm" onChange={e => setBirthTime(e.target.value)}>
                                                {["子时","丑时","寅时","卯时","辰时","巳时","午时","未时","申时","酉时","戌时","亥时"].map(s => <option key={s}>{s}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    <button onClick={calculateFate} className="w-full bg-indigo-600 hover:bg-indigo-500 py-3 mt-2 rounded-xl font-bold transition-all active:scale-[0.98] shadow-lg shadow-indigo-900/30">
                                        推演命运轨迹
                                    </button>
                                </div>
                            </section>

                            {/* 右上：遗憾输入 */}
                            <section className="glass-card p-8 rounded-3xl min-h-[280px] flex flex-col justify-center">
                                <h3 className="text-emerald-400 font-bold mb-6 flex items-center">
                                    <span className="w-6 h-6 rounded-full border border-emerald-400 flex items-center justify-center text-xs mr-2">2</span>
                                    记叙心中遗憾
                                </h3>
                                <textarea
                                    className="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl h-24 outline-none mb-4 text-sm resize-none focus:border-emerald-500 transition-colors"
                                    placeholder="如果我2023年没有和女友分手会发生什么？或者输入其他让你遗憾的事..."
                                    value={regret}
                                    onChange={e => setRegret(e.target.value)}
                                />
                                <button
                                    onClick={callDeepSeek}
                                    disabled={isLoading}
                                    className={`w-full py-3 rounded-xl font-bold transition-all active:scale-[0.98] shadow-lg ${isLoading ? 'bg-slate-700' : 'bg-gradient-to-r from-emerald-600 to-indigo-600 hover:opacity-90'}`}
                                >
                                    {isLoading ? <span className="loading-dots">AI 正在重写平行时空</span> : "启动平行时空续写"}
                                </button>
                            </section>
                        </div>

                        {/* 下排：结果区（动态显示） */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
                            
                            {/* 左下：命理结果 */}
                            <div className={fateData ? "animate-fadeIn" : "hidden"}>
                                <section className="glass-card p-8 rounded-3xl h-full">
                                    <h3 className="text-indigo-300 font-bold mb-6 border-b border-slate-800 pb-3 flex justify-between items-center">
                                        <span>大运与流年排盘</span>
                                        <span className="text-[10px] text-slate-500 font-normal">CHART ANALYSIS</span>
                                    </h3>
                                    {fateData && (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div className="space-y-3">
                                                <p className="text-xs text-indigo-500 font-bold uppercase tracking-wider mb-2">十年大运 (宜行)</p>
                                                {fateData.dayun.map((d, i) => (
                                                    <div key={i} className="bazi-tag p-3 rounded-xl">
                                                        <div className="flex justify-between text-[10px] text-indigo-400 font-bold">
                                                            <span>{d.period}</span>
                                                            <span>{d.age}</span>
                                                        </div>
                                                        <div className="text-sm font-bold text-slate-200 my-1">{d.theme}</div>
                                                        <div className="text-xs text-emerald-500 italic">✓ {d.suit}</div>
                                                    </div>
                                                ))}
                                            </div>
                                            <div className="space-y-3">
                                                <p className="text-xs text-red-500 font-bold uppercase tracking-wider mb-2">流年往复 (禁忌)</p>
                                                {fateData.liunian.map((l, i) => (
                                                    <div key={i} className="warning-tag p-3 rounded-xl">
                                                        <div className="flex justify-between text-[10px] text-red-400 font-bold">
                                                            <span>{l.year}年</span>
                                                            <span>{l.name}年</span>
                                                        </div>
                                                        <div className="text-sm text-red-200 mt-1">✗ {l.taboo}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </section>
                            </div>

                            {/* 右下：续写结果 */}
                            <div className={aiStory || isLoading ? "animate-fadeIn" : "hidden"}>
                                <section className="glass-card p-8 rounded-3xl border-t-2 border-emerald-500/50 h-full">
                                    <h3 className="text-emerald-400 font-bold mb-6 border-b border-slate-800 pb-3 flex justify-between items-center">
                                        <span>平行时空的信件</span>
                                        <span className="text-[10px] text-slate-500 font-normal">HEALING STORY</span>
                                    </h3>
                                    {aiStory ? (
                                        <div className="space-y-4">
                                            <p className="text-slate-300 leading-relaxed italic text-base whitespace-pre-wrap">
                                                {aiStory}
                                            </p>
                                            <div className="pt-6 border-t border-slate-800 flex justify-between items-center">
                                                <span className="text-[10px] text-slate-600 uppercase tracking-tighter">Generated by DeepSeek AI</span>
                                                <span className="text-emerald-500 font-bold text-sm tracking-widest">— 活在当下，即是新生 —</span>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="py-20 text-center">
                                            <span className="loading-dots text-slate-500">正在为您检索另一种可能</span>
                                        </div>
                                    )}
                                </section>
                            </div>

                        </div>
                    </div>

                    <footer className="mt-20 mb-8 text-center text-slate-700 text-[10px] tracking-[0.3em] uppercase">
                        The Book of Destiny © 2026 | All Stories Rewrite by AI
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
