<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>命运之书 Pro - 深度大运流年分析</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap');
        body { background: #020617; color: #f1f5f9; font-family: 'Noto Serif SC', serif; }
        .glass-card { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); }
        .bazi-tag { background: #1e293b; border-left: 3px solid #6366f1; }
        .warning-tag { background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; }
        .success-tag { background: rgba(34, 197, 94, 0.1); border-left: 3px solid #22c55e; }
        .loading-dots:after { content: ' .'; animation: dots 1.5s steps(5, end) infinite;}
        @keyframes dots { 0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); } 40% { color: white; } 60% { text-shadow: .25em 0 0 white; } 80%, 100% { text-shadow: .25em 0 0 white, .5em 0 0 white; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        // API Key 安全混淆
        const ENCODED_KEY = "c2stYjQ2OWIwNDNhNjE2NGNjODkzM2ZiZDg2M2I0NTgzMTg=";
        const getApiKey = () => atob(ENCODED_KEY);

        const App = () => {
            const [birthDate, setBirthDate] = useState('');
            const [birthTime, setBirthTime] = useState('子时');
            const [regret, setRegret] = useState('');
            const [fateData, setFateData] = useState(null);
            const [aiStory, setAiStory] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const gan = ['庚', '辛', '壬', '癸', '甲', '乙', '丙', '丁', '戊', '己'];
            const zhi = ['申', '酉', '戌', '亥', '子', '丑', '寅', '卯', '辰', '巳', '午', '未'];

            const calculateFate = () => {
                if (!birthDate) return alert("请先填写出生日期");
                const date = new Date(birthDate);
                const birthYear = date.getFullYear();

                // 1. 计算大运 (每10年一步大运，简化推算起运年)
                const startAge = (birthYear % 10) || 5; // 模拟起运年龄
                const dayun = [];
                const dayunThemes = ["学业与探索期", "事业开拓与立业期", "财富积累与守成期", "健康与智慧升华期"];
                const dayunSuits = ["适合深造、异地求学", "适合创业、建立人脉", "适合稳健投资、房产配置", "适合授业、公益与养生"];
                
                for(let i=0; i<4; i++) {
                    const startYear = birthYear + startAge + (i * 10);
                    dayun.push({
                        period: `${startYear} - ${startYear + 9}`,
                        age: `${startAge + (i * 10)}岁 - ${startAge + (i * 10) + 9}岁`,
                        theme: dayunThemes[i],
                        suit: dayunSuits[i]
                    });
                }

                // 2. 计算流年 (未来8年禁忌)
                const liunian = [];
                const currentYear = 2026;
                const taboos = [
                    "忌盲目跳槽，防口舌是非", "忌大额借贷，防财物遗失", "忌熬夜透支，防心肺之疾",
                    "忌与人合伙，防契约纠纷", "忌出海远行，防意外磕碰", "忌动土装修，防宅气受损",
                    "忌感情用事，防关系破裂", "忌孤注一掷，防投机落空"
                ];

                for(let i=0; i<8; i++) {
                    const year = currentYear + i;
                    liunian.push({
                        year: year,
                        name: gan[year % 10] + zhi[year % 12],
                        taboo: taboos[(year + date.getDate()) % taboos.length]
                    });
                }

                setFateData({ dayun, liunian, nianZhu: gan[birthYear % 10] + zhi[birthYear % 12] });
            };

            const callDeepSeek = async () => {
                if (!regret) return alert("写下你的遗憾");
                setIsLoading(true);
                try {
                    const response = await fetch("https://api.deepseek.com/chat/completions", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${getApiKey()}`
                        },
                        body: JSON.stringify({
                            model: "deepseek-chat",
                            messages: [
                                { role: "system", content: "你是一位精通命理的治愈系作家。请根据用户的遗憾，续写平行时空的故事，要求结局圆满、充满正能量，引导用户接纳过去并积极生活。" },
                                { role: "user", content: regret }
                            ],
                            temperature: 0.7
                        })
                    });
                    const data = await response.json();
                    setAiStory(data.choices[0].message.content);
                } catch (e) {
                    setAiStory("此时平行时空正在维护，请稍后再试。");
                } finally { setIsLoading(false); }
            };

            return (
                <div className="min-h-screen p-4 md:p-10 max-w-6xl mx-auto">
                    <header className="text-center mb-12">
                        <h1 className="text-4xl font-bold bg-gradient-to-r from-indigo-400 to-purple-500 bg-clip-text text-transparent">
                            命运之书 · 完整命理版
                        </h1>
                        <p className="text-slate-500 mt-2 italic">—— “推演大运流年，在平行时空治愈遗憾”</p>
                    </header>

                    <div className="grid lg:grid-cols-12 gap-8">
                        {/* 左侧控制区 */}
                        <div className="lg:col-span-4 space-y-6">
                            <section className="glass-card p-6 rounded-3xl">
                                <h3 className="text-indigo-400 font-bold mb-4">生辰信息</h3>
                                <div className="space-y-4">
                                    <input type="date" className="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl outline-none" onChange={e => setBirthDate(e.target.value)} />
                                    <select className="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl outline-none" onChange={e => setBirthTime(e.target.value)}>
                                        {["子时","丑时","寅时","卯时","辰时","巳时","午时","未时","申时","酉时","戌时","亥时"].map(s => <option key={s}>{s}</option>)}
                                    </select>
                                    <button onClick={calculateFate} className="w-full bg-indigo-600 hover:bg-indigo-500 py-3 rounded-xl font-bold transition shadow-lg shadow-indigo-900/20">
                                        开始排盘
                                    </button>
                                </div>
                            </section>

                            <section className="glass-card p-6 rounded-3xl">
                                <h3 className="text-emerald-400 font-bold mb-4">遗憾续写</h3>
                                <textarea className="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl h-32 outline-none mb-4 text-sm" placeholder="如果2023年没有和女友分手..." value={regret} onChange={e => setRegret(e.target.value)} />
                                <button onClick={callDeepSeek} disabled={isLoading} className="w-full bg-gradient-to-r from-emerald-600 to-indigo-600 py-3 rounded-xl font-bold transition">
                                    {isLoading ? <span className="loading-dots">穿越中</span> : "AI 续写圆满结局"}
                                </button>
                            </section>
                        </div>

                        {/* 右侧展示区 */}
                        <div className="lg:col-span-8 space-y-6">
                            {fateData ? (
                                <div className="grid md:grid-cols-2 gap-6 animate-fade-in">
                                    {/* 大运板块 */}
                                    <div className="glass-card p-6 rounded-3xl">
                                        <h3 className="text-xl font-bold text-indigo-300 mb-4 border-b border-indigo-900/50 pb-2">十年大运 · 宜行事项</h3>
                                        <div className="space-y-4">
                                            {fateData.dayun.map((d, i) => (
                                                <div key={i} className="bazi-tag p-3 rounded-lg">
                                                    <div className="flex justify-between text-xs text-indigo-400 font-bold mb-1">
                                                        <span>{d.period}</span>
                                                        <span>{d.age}</span>
                                                    </div>
                                                    <div className="text-sm font-bold text-slate-200">{d.theme}</div>
                                                    <div className="text-xs text-emerald-400 mt-1 italic">✓ {d.suit}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* 流年板块 */}
                                    <div className="glass-card p-6 rounded-3xl">
                                        <h3 className="text-xl font-bold text-red-300 mb-4 border-b border-red-900/50 pb-2">流年往复 · 避坑禁忌</h3>
                                        <div className="space-y-4">
                                            {fateData.liunian.map((l, i) => (
                                                <div key={i} className="warning-tag p-3 rounded-lg">
                                                    <div className="flex justify-between text-xs text-red-400 font-bold mb-1">
                                                        <span>{l.year}年</span>
                                                        <span>{l.name}年</span>
                                                    </div>
                                                    <div className="text-xs text-slate-300">当年不宜事项：</div>
                                                    <div className="text-sm text-red-200 mt-1 font-semibold">✗ {l.taboo}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="glass-card h-64 flex items-center justify-center rounded-3xl border-dashed border-2 border-slate-800">
                                    <p className="text-slate-600 italic">请输入生辰信息以解锁命运轨迹</p>
                                </div>
                            )}

                            {aiStory && (
                                <div className="glass-card p-8 rounded-3xl border-t-4 border-emerald-500 animate-fade-in">
                                    <div className="flex items-center mb-4">
                                        <div className="w-8 h-8 bg-emerald-500 rounded-full flex items-center justify-center mr-3 text-lg">✨</div>
                                        <h3 className="text-xl font-bold text-emerald-400">平行时空的回答</h3>
                                    </div>
                                    <p className="text-slate-300 leading-relaxed italic text-lg line-clamp-none whitespace-pre-wrap">{aiStory}</p>
                                    <div className="mt-6 pt-4 border-t border-slate-800 text-right text-sm text-slate-500 font-bold">
                                        — 此时此刻，即是新生 —
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    <footer className="mt-16 text-center text-slate-600 text-[10px] tracking-[0.2em] uppercase">
                        The Book of Destiny © 2026 | Powered by DeepSeek & BaZi Logic
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
