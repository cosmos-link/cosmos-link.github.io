<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>命运之书 Pro - 平行人生治愈版</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap');
        body { background: #020617; color: #f1f5f9; font-family: 'Noto Serif SC', serif; overflow-x: hidden; }
        .glass-card { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); height: 100%; }
        .bazi-tag { background: #1e293b; border-left: 3px solid #6366f1; }
        .warning-tag { background: rgba(239, 68, 68, 0.05); border-left: 3px solid #ef4444; }
        .loading-dots:after { content: ' .'; animation: dots 1.5s steps(5, end) infinite;}
        @keyframes dots { 0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); } 40% { color: white; } 60% { text-shadow: .25em 0 0 white; } 80%, 100% { text-shadow: .25em 0 0 white, .5em 0 0 white; } }
        /* 响应式调整高度 */
        @media (min-width: 1024px) { .quadrant-height { height: calc(50vh - 80px); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        const ENCODED_KEY = "c2stYjQ2OWIwNDNhNjE2NGNjODkzM2ZiZDg2M2I0NTgzMTg=";
        const getApiKey = () => atob(ENCODED_KEY);

        const App = () => {
            const [birthDate, setBirthDate] = useState('');
            const [birthTime, setBirthTime] = useState('子时');
            const [regret, setRegret] = useState('');
            const [fateData, setFateData] = useState(null);
            const [aiStory, setAiStory] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const calculateFate = () => {
                if (!birthDate) return alert("请先填写出生日期");
                const date = new Date(birthDate);
                const birthYear = date.getFullYear();
                const gan = ['庚', '辛', '壬', '癸', '甲', '乙', '丙', '丁', '戊', '己'];
                const zhi = ['申', '酉', '戌', '亥', '子', '丑', '寅', '卯', '辰', '巳', '午', '未'];

                const startAge = (birthYear % 10) || 5;
                const dayun = [];
                const dayunThemes = ["学业与探索", "事业与立业", "财富与守成", "智慧与养生"];
                const dayunSuits = ["适合求学深造", "适合创业开拓", "适合资产配置", "适合授业修身"];
                for(let i=0; i<4; i++) {
                    const startYear = birthYear + startAge + (i * 10);
                    dayun.push({ period: `${startYear}-${startYear+9}`, age: `${startAge+(i*10)}岁`, theme: dayunThemes[i], suit: dayunSuits[i] });
                }

                const liunian = [];
                const currentYear = 2026;
                const taboos = ["忌盲目跳槽", "忌大额借贷", "忌透支健康", "忌契约纠纷", "忌出海远走", "忌动土装修", "忌感情用事", "忌孤注一掷"];
                for(let i=0; i<8; i++) {
                    const year = currentYear + i;
                    liunian.push({ year, name: gan[year % 10] + zhi[year % 12], taboo: taboos[(year + date.getDate()) % taboos.length] });
                }
                setFateData({ dayun, liunian });
            };

            const callDeepSeek = async () => {
                if (!regret) return alert("写下你的遗憾");
                setIsLoading(true);
                try {
                    const response = await fetch("https://api.deepseek.com/chat/completions", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${getApiKey()}` },
                        body: JSON.stringify({
                            model: "deepseek-chat",
                            messages: [{ role: "system", content: "你是一位精通命理的治愈系作家。请根据用户的遗憾，续写平行时空的故事，要求结局圆满、充满正能量，引导用户接纳过去并积极生活。" }, { role: "user", content: regret }],
                            temperature: 0.7
                        })
                    });
                    const data = await response.json();
                    setAiStory(data.choices[0].message.content);
                } catch (e) {
                    setAiStory("信号穿越中受阻，请稍后再试。");
                } finally { setIsLoading(false); }
            };

            return (
                <div className="min-h-screen p-4 flex flex-col">
                    <header className="text-center mb-6">
                        <h1 className="text-3xl font-bold bg-gradient-to-r from-indigo-400 to-purple-500 bg-clip-text text-transparent">命运之书 Pro</h1>
                    </header>

                    <div className="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-6 max-w-7xl mx-auto w-full">
                        
                        {/* 1. 左上：生辰输入 */}
                        <div className="quadrant-height">
                            <section className="glass-card p-6 rounded-3xl flex flex-col justify-center">
                                <h3 className="text-indigo-400 font-bold mb-4 flex items-center">
                                    <span className="mr-2">❶</span> 生辰起卦
                                </h3>
                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <input type="date" className="bg-slate-900 border border-slate-700 p-3 rounded-xl outline-none text-sm" onChange={e => setBirthDate(e.target.value)} />
                                        <select className="bg-slate-900 border border-slate-700 p-3 rounded-xl outline-none text-sm" onChange={e => setBirthTime(e.target.value)}>
                                            {["子时","丑时","寅时","卯时","辰时","巳时","午时","未时","申时","酉时","戌时","亥时"].map(s => <option key={s}>{s}</option>)}
                                        </select>
                                    </div>
                                    <button onClick={calculateFate} className="w-full bg-indigo-600 hover:bg-indigo-500 py-3 rounded-xl font-bold transition">推演命运轨迹</button>
                                </div>
                            </section>
                        </div>

                        {/* 2. 右上：遗憾输入 */}
                        <div className="quadrant-height text-right">
                            <section className="glass-card p-6 rounded-3xl flex flex-col justify-center">
                                <h3 className="text-emerald-400 font-bold mb-4 flex items-center justify-end">
                                    遗憾记叙 <span className="ml-2">❷</span>
                                </h3>
                                <textarea className="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl h-24 outline-none mb-3 text-sm resize-none" placeholder="描述那件让你遗憾的事..." value={regret} onChange={e => setRegret(e.target.value)} />
                                <button onClick={callDeepSeek} disabled={isLoading} className="w-full bg-gradient-to-r from-emerald-600 to-indigo-600 py-3 rounded-xl font-bold transition">
                                    {isLoading ? <span className="loading-dots">AI 正在重写时空</span> : "启动平行时空续写"}
                                </button>
                            </section>
                        </div>

                        {/* 3. 左下：命理结果 */}
                        <div className="quadrant-height">
                            <section className="glass-card p-6 rounded-3xl overflow-hidden flex flex-col">
                                <h3 className="text-indigo-300 font-bold mb-3 border-b border-slate-800 pb-2 flex justify-between items-center">
                                    <span>❸ 大运与流年</span>
                                    <span className="text-[10px] text-slate-500 font-normal">FUTURE PATH</span>
                                </h3>
                                <div className="flex-1 overflow-y-auto space-y-4 pr-2 custom-scroll">
                                    {fateData ? (
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="space-y-2">
                                                <p className="text-[10px] text-indigo-500 font-bold">十年大运(宜)</p>
                                                {fateData.dayun.map((d, i) => (
                                                    <div key={i} className="bazi-tag p-2 rounded text-[11px]">
                                                        <div className="text-indigo-400 font-bold">{d.period}</div>
                                                        <div className="text-slate-300">{d.theme}</div>
                                                        <div className="text-emerald-500 italic">{d.suit}</div>
                                                    </div>
                                                ))}
                                            </div>
                                            <div className="space-y-2">
                                                <p className="text-[10px] text-red-500 font-bold">流年禁忌(忌)</p>
                                                {fateData.liunian.map((l, i) => (
                                                    <div key={i} className="warning-tag p-2 rounded text-[11px]">
                                                        <div className="text-red-400 font-bold">{l.year} {l.name}</div>
                                                        <div className="text-red-200">{l.taboo}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="h-full flex items-center justify-center text-slate-700 text-sm italic">等待生辰数据输入...</div>
                                    )}
                                </div>
                            </section>
                        </div>

                        {/* 4. 右下：续写结果 */}
                        <div className="quadrant-height">
                            <section className="glass-card p-6 rounded-3xl border-t-2 border-emerald-500/50 flex flex-col">
                                <h3 className="text-emerald-400 font-bold mb-3 border-b border-slate-800 pb-2 flex justify-between items-center">
                                    <span>❹ 治愈之书</span>
                                    <span className="text-[10px] text-slate-500 font-normal">HEALING STORY</span>
                                </h3>
                                <div className="flex-1 overflow-y-auto pr-2 custom-scroll">
                                    {aiStory ? (
                                        <p className="text-slate-300 leading-relaxed italic text-sm whitespace-pre-wrap animate-fade-in pb-4">
                                            {aiStory}
                                        </p>
                                    ) : (
                                        <div className="h-full flex items-center justify-center text-slate-700 text-sm italic text-center">
                                            {isLoading ? "正在为您检索平行时空的另一种可能..." : "在右上方输入遗憾，开启治愈之旅"}
                                        </div>
                                    )}
                                </div>
                            </section>
                        </div>

                    </div>

                    <footer className="text-center py-4 text-slate-700 text-[10px] tracking-widest uppercase">
                        The Book of Destiny © 2026 | Professional Edition
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
