<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>天枢命理 Destiny Engine Pro</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Zhi+Mang+Xing&display=swap');
        body { background: #0a0a0a; color: #e2e8f0; font-family: 'Noto Serif SC', serif; }
        .glass { background: rgba(23, 23, 23, 0.85); backdrop-filter: blur(20px); border: 1px solid rgba(184, 134, 11, 0.2); }
        .title-font { font-family: 'Zhi Mang Xing', cursive; }
        .gold-gradient { background: linear-gradient(135deg, #b8860b 0%, #ffd700 50%, #b8860b 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .report-content { white-space: pre-wrap; line-height: 1.8; font-size: 0.95rem; color: #cbd5e1; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        const KEY = "c2stYjQ2OWIwNDNhNjE2NGNjODkzM2ZiZDg2M2I0NTgzMTg=";
        const getK = () => atob(KEY);

        const App = () => {
            const [user, setUser] = useState({ date: '', time: '子时', sex: '男', loc: '', regret: '' });
            const [res, setRes] = useState({ report: '', story: '', guide: '' });
            const [loading, setLoading] = useState(false);

            // 核心请求函数：移除位置获取，直接传参
            const callAI = async (sys, prompt, target) => {
                setLoading(true);
                try {
                    const resp = await fetch("https://api.deepseek.com/chat/completions", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${getK()}` },
                        body: JSON.stringify({
                            model: "deepseek-chat",
                            messages: [{ role: "system", content: sys }, { role: "user", content: prompt }]
                        })
                    });
                    const data = await resp.json();
                    setRes(prev => ({ ...prev, [target]: data.choices[0].message.content }));
                } catch (e) {
                    console.error(e);
                    alert("系统繁忙，请稍后再试");
                } finally {
                    setLoading(false);
                }
            };

            const handleAnalysis = () => {
                if(!user.date || !user.loc) return alert("请填写出生日期和地点");
                const sys = `你是一名专业命理大师。1.输出八字数列。2.剖析性格及操作建议。3.分析财运仕途。4.明确起运年及转运点。5.判定当年吉凶（含犯小人预防）。注意：必须根据用户输入的城市(${user.loc})，在后台检索经纬度并计算真太阳时偏移。`;
                callAI(sys, `生日：${user.date}，时辰：${user.time}，城市：${user.loc}，性别：${user.sex}`, 'report');
            };

            return (
                <div className="max-w-6xl mx-auto p-6 py-10">
                    <header className="text-center mb-12">
                        <h1 className="text-5xl title-font gold-gradient mb-2">天枢命理专家系统</h1>
                        <p className="text-gray-600 tracking-[0.4em] text-[10px]">PROFESSIONAL DESTINY ENGINE</p>
                    </header>

                    <div className="grid lg:grid-cols-2 gap-8">
                        {/* 输入区 */}
                        <div className="space-y-6">
                            <section className="glass p-8 rounded-3xl">
                                <h2 className="text-lg font-bold text-yellow-600 mb-6 flex items-center">
                                    <span className="w-2 h-2 bg-yellow-600 rounded-full mr-2"></span>
                                    生辰起卦 (无需定位，直接输入)
                                </h2>
                                <div className="grid grid-cols-2 gap-4 mb-6">
                                    <div className="col-span-2">
                                        <input type="date" className="w-full bg-black border border-gray-800 p-3 rounded-xl outline-none focus:border-yellow-600" onChange={e => setUser({...user, date: e.target.value})} />
                                    </div>
                                    <select className="bg-black border border-gray-800 p-3 rounded-xl outline-none" onChange={e => setUser({...user, time: e.target.value})}>
                                        {["子时","丑时","寅时","卯时","辰时","巳时","午时","未时","申时","酉时","戌时","亥时"].map(s => <option key={s}>{s}</option>)}
                                    </select>
                                    <select className="bg-black border border-gray-800 p-3 rounded-xl outline-none" onChange={e => setUser({...user, sex: e.target.value})}>
                                        <option>男</option><option>女</option>
                                    </select>
                                    <div className="col-span-2">
                                        <input type="text" placeholder="请输入出生城市 (如：北京 或 纽约)" className="w-full bg-black border border-gray-800 p-3 rounded-xl outline-none focus:border-yellow-600" onChange={e => setUser({...user, loc: e.target.value})} />
                                    </div>
                                </div>
                                <button onClick={handleAnalysis} disabled={loading} className="w-full py-4 bg-yellow-600 text-black font-bold rounded-2xl hover:opacity-90 active:scale-95 transition-all">
                                    {loading ? "天枢演算中..." : "开启分析报告"}
                                </button>
                            </section>

                            <section className="glass p-8 rounded-3xl">
                                <h2 className="text-lg font-bold text-emerald-500 mb-4 flex items-center">
                                    <span className="w-2 h-2 bg-emerald-500 rounded-full mr-2"></span>
                                    平行人生续写
                                </h2>
                                <textarea className="w-full bg-black border border-gray-800 p-4 rounded-xl h-24 outline-none text-sm mb-4 resize-none focus:border-emerald-600" placeholder="记叙您的遗憾..." onChange={e => setUser({...user, regret: e.target.value})} />
                                <button onClick={() => callAI("平行宇宙编剧", user.regret, 'story')} className="w-full py-3 bg-emerald-800 text-white font-bold rounded-xl hover:bg-emerald-700 transition-all">推演平行故事</button>
                            </section>
                        </div>

                        {/* 输出区 */}
                        <div className="space-y-6">
                            {res.report ? (
                                <div className="glass p-8 rounded-3xl border-l-4 border-yellow-600 animate-in fade-in slide-in-from-right-4">
                                    <h3 className="text-yellow-600 font-bold mb-4 border-b border-gray-800 pb-2">命理全维度报告</h3>
                                    <div className="report-content">{res.report}</div>
                                </div>
                            ) : (
                                <div className="h-full flex items-center justify-center glass rounded-3xl border-dashed border-2 border-gray-900 min-h-[400px]">
                                    <p className="text-gray-700 italic">请输入信息并点击开启分析</p>
                                </div>
                            )}

                            {res.story && (
                                <div className="glass p-8 rounded-3xl border-l-4 border-emerald-600 italic text-gray-400 text-sm animate-in fade-in">
                                    <h3 className="text-emerald-500 font-bold mb-2 not-italic">平行宇宙预览：</h3>
                                    {res.story}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
